name: Gui Release

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: write

env:
  GUI_DIR: cmd/npc/npc-gui
  FRONTEND_DIR: cmd/npc/npc-gui/frontend
  WAILS_VERSION: v2.11.0
  APP_NAME: npc-gui

jobs:
  build_windows:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - platform: windows/386
            os_name: windows
            arch: 386
          - platform: windows/amd64
            os_name: windows
            arch: amd64
          - platform: windows/arm64
            os_name: windows
            arch: arm64
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: yarn
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/yarn.lock

      - name: Enable Yarn (corepack)
        run: corepack enable

      - name: Install frontend dependencies
        run: yarn install --frozen-lockfile
        working-directory: ${{ env.FRONTEND_DIR }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GUI_DIR }}/go.mod
          check-latest: true

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@${{ env.WAILS_VERSION }}
        working-directory: ${{ env.GUI_DIR }}

      - name: Build and package (Windows)
        shell: pwsh
        working-directory: ${{ env.GUI_DIR }}
        run: |
          $wails = Join-Path (go env GOPATH) "bin\\wails.exe"
          $tagArgs = @()
          if ($env:WAILS_TAGS) { $tagArgs += @("-tags", $env:WAILS_TAGS) }
          & $wails build -m -s -trimpath -skipbindings @tagArgs -platform ${{ matrix.platform }} -o "$env:APP_NAME.exe"
          Set-Location build\bin
          $zipName = "$env:APP_NAME-${{ matrix.os_name }}-${{ matrix.arch }}.zip"
          $exe = Get-ChildItem -Path . -Filter *.exe | Select-Object -First 1
          if (-not $exe) {
            $exe = Get-ChildItem -Path . -File | Select-Object -First 1
          }
          if (-not $exe) {
            Write-Host "No build output found in build/bin"
            Get-ChildItem -Path . | Format-Table -AutoSize
            exit 1
          }
          Compress-Archive -Path $exe.Name -DestinationPath $zipName -Force

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds-${{ matrix.arch }}
          path: ${{ env.GUI_DIR }}/build/bin/${{ env.APP_NAME }}-${{ matrix.os_name }}-${{ matrix.arch }}.zip

  build_macos:
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - platform: darwin/amd64
            os_name: darwin
            arch: amd64
          - platform: darwin/arm64
            os_name: darwin
            arch: arm64
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: yarn
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/yarn.lock

      - name: Enable Yarn (corepack)
        run: corepack enable

      - name: Install frontend dependencies
        run: yarn install --frozen-lockfile
        working-directory: ${{ env.FRONTEND_DIR }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GUI_DIR }}/go.mod
          check-latest: true

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@${{ env.WAILS_VERSION }}
        working-directory: ${{ env.GUI_DIR }}

      - name: Build and package (macOS)
        shell: bash
        working-directory: ${{ env.GUI_DIR }}
        run: |
          wails="$(go env GOPATH)/bin/wails"
          tagArgs=()
          if [ -n "$WAILS_TAGS" ]; then
            tagArgs+=( -tags "$WAILS_TAGS" )
          fi
          "$wails" build -m -s -trimpath -skipbindings "${tagArgs[@]}" -platform "${{ matrix.platform }}" -o "$APP_NAME"
          cd build/bin
          app="$(ls -1d *.app 2>/dev/null | head -n 1)"
          if [ -z "$app" ]; then
            echo "No .app found in build/bin"
            ls -la
            exit 1
          fi
          zip -q -r "$APP_NAME-${{ matrix.os_name }}-${{ matrix.arch }}.zip" "$app"

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds-${{ matrix.arch }}
          path: ${{ env.GUI_DIR }}/build/bin/${{ env.APP_NAME }}-${{ matrix.os_name }}-${{ matrix.arch }}.zip

  build_linux:
    runs-on: ubuntu-latest
    env:
      WAILS_TAGS: webkit2_41
    strategy:
      matrix:
        include:
          - platform: linux/amd64
            os_name: linux
            arch: amd64
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: yarn
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/yarn.lock

      - name: Enable Yarn (corepack)
        run: corepack enable

      - name: Install frontend dependencies
        run: yarn install --frozen-lockfile
        working-directory: ${{ env.FRONTEND_DIR }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GUI_DIR }}/go.mod
          check-latest: true

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@${{ env.WAILS_VERSION }}
        working-directory: ${{ env.GUI_DIR }}

      - name: Build and package (Linux)
        shell: bash
        working-directory: ${{ env.GUI_DIR }}
        run: |
          wails="$(go env GOPATH)/bin/wails"
          tagArgs=()
          if [ -n "$WAILS_TAGS" ]; then
            tagArgs+=( -tags "$WAILS_TAGS" )
          fi
          "$wails" build -m -s -trimpath -skipbindings "${tagArgs[@]}" -platform "${{ matrix.platform }}" -o "$APP_NAME"
          cd build/bin
          bin="$(find . -maxdepth 1 -type f -perm -111 -printf '%f\n' | head -n 1)"
          if [ -z "$bin" ]; then
            echo "No executable file found in build/bin"
            ls -la
            exit 1
          fi
          zip -q "$APP_NAME-${{ matrix.os_name }}-${{ matrix.arch }}.zip" "$bin"

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds-${{ matrix.arch }}
          path: ${{ env.GUI_DIR }}/build/bin/${{ env.APP_NAME }}-${{ matrix.os_name }}-${{ matrix.arch }}.zip

  upload_release:
    runs-on: ubuntu-latest
    needs: [build_windows, build_macos, build_linux]
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/**/*.zip
          tag_name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
