name: Gui Release

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: write

env:
  GUI_DIR: cmd/npc/npc-gui
  FRONTEND_DIR: cmd/npc/npc-gui/frontend
  WAILS_VERSION: v2.11.0
  WAILS_TAGS: webkit2_41
  APP_NAME: nps-client

jobs:
  build_windows:
    runs-on: windows-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: yarn
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/yarn.lock

      - name: Enable Yarn (corepack)
        run: corepack enable

      - name: Install frontend dependencies
        run: yarn install --frozen-lockfile
        working-directory: ${{ env.FRONTEND_DIR }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GUI_DIR }}/go.mod
          check-latest: true

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@${{ env.WAILS_VERSION }}
        working-directory: ${{ env.GUI_DIR }}

      - name: Build and package (Windows)
        shell: pwsh
        working-directory: ${{ env.GUI_DIR }}
        run: |
          $arch = (go env GOARCH)
          $wails = Join-Path (go env GOPATH) "bin\\wails.exe"
          & $wails build -m -s -trimpath -skipbindings -tags $env:WAILS_TAGS -o $env:APP_NAME
          Set-Location build\bin
          $zipName = "$env:APP_NAME-windows-$arch.zip"
          Compress-Archive -Path "$env:APP_NAME.exe" -DestinationPath $zipName -Force

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: ${{ env.GUI_DIR }}/build/bin/*.zip

  build_macos:
    runs-on: macos-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: yarn
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/yarn.lock

      - name: Enable Yarn (corepack)
        run: corepack enable

      - name: Install frontend dependencies
        run: yarn install --frozen-lockfile
        working-directory: ${{ env.FRONTEND_DIR }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GUI_DIR }}/go.mod
          check-latest: true

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@${{ env.WAILS_VERSION }}
        working-directory: ${{ env.GUI_DIR }}

      - name: Build and package (macOS)
        shell: bash
        working-directory: ${{ env.GUI_DIR }}
        run: |
          arch="$(go env GOARCH)"
          wails="$(go env GOPATH)/bin/wails"
          "$wails" build -m -s -trimpath -skipbindings -tags "$WAILS_TAGS" -o "$APP_NAME"
          cd build/bin
          zip -q -r "$APP_NAME-darwin-$arch.zip" "$APP_NAME.app"

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds
          path: ${{ env.GUI_DIR }}/build/bin/*.zip

  build_linux:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: yarn
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/yarn.lock

      - name: Enable Yarn (corepack)
        run: corepack enable

      - name: Install frontend dependencies
        run: yarn install --frozen-lockfile
        working-directory: ${{ env.FRONTEND_DIR }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GUI_DIR }}/go.mod
          check-latest: true

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@${{ env.WAILS_VERSION }}
        working-directory: ${{ env.GUI_DIR }}

      - name: Build and package (Linux)
        shell: bash
        working-directory: ${{ env.GUI_DIR }}
        run: |
          arch="$(go env GOARCH)"
          wails="$(go env GOPATH)/bin/wails"
          "$wails" build -m -s -trimpath -skipbindings -tags "$WAILS_TAGS" -o "$APP_NAME"
          cd build/bin
          zip -q "$APP_NAME-linux-$arch.zip" "$APP_NAME"

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: ${{ env.GUI_DIR }}/build/bin/*.zip

  upload_release:
    runs-on: ubuntu-latest
    needs: [build_windows, build_macos, build_linux]
    if: github.event_name == 'release'
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
